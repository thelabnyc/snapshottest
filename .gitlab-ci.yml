workflow:
  rules:
    - if: $CI_COMMIT_REF_PROTECTED == "true"
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

stages:
  - test
  - release

services: []

include:
  - component: gitlab.com/thelabnyc/thelab-ci-components/review@0.7.1
  - component: gitlab.com/thelabnyc/thelab-ci-components/precommit@0.7.1
  - component: gitlab.com/thelabnyc/thelab-ci-components/publish-gitlab-release@0.7.1

test:
  stage: test
  image: "registry.gitlab.com/thelabnyc/python:${IMAGE}"
  script:
    - uv sync
    - uv run tox
  parallel:
    matrix:
      - IMAGE: "3.11"
        TOX_SKIP_ENV: "^(?!py311)"
      - IMAGE: "3.12"
        TOX_SKIP_ENV: "^(?!py312)"
      - IMAGE: "3.13"
        TOX_SKIP_ENV: "^(?!py313)"
      - IMAGE: "3.14"
        TOX_SKIP_ENV: "^(?!py314)"

publish-to-pypi:
  stage: release
  image: registry.gitlab.com/thelabnyc/python:3.14.1227@sha256:d3dae5607394565c6393500d7f59a9a0ba8bfacea17097df9ad5bcc6f75f2019
  rules:
    - if: $CI_COMMIT_TAG && $CI_COMMIT_REF_PROTECTED
  environment:
    name: release
    deployment_tier: production
  script:
    - pip install twine
    # Build package
    - uv build
    # Publish to Gitlab's package registry
    - export TWINE_USERNAME=gitlab-ci-token
    - export TWINE_PASSWORD=${CI_JOB_TOKEN}
    - python -m twine upload
      --repository-url https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/packages/pypi
      dist/*
